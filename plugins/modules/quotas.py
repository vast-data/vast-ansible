#!/usr/bin/python
# -*- coding: utf-8 -*-
# Copyright: (c) 2026, VAST Data
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

from __future__ import absolute_import, division, print_function

__metaclass__ = type

# BEGIN AUTOGENERATED DOCUMENTATION
DOCUMENTATION = r"""
---
module: quotas
short_description: Manage VAST Quota resources
description:
  - Create, update, or delete VAST Quota resources.
  - Supports check_mode and diff for idempotent operations.
version_added: "1.0.0"
options:
  vms:
    description: VAST VMS connection parameters.
    type: dict
    required: true
    suboptions:
      host:
        description: VAST VMS hostname or IP address.
        required: true
        type: str
      validate_certs:
        description: Validate SSL certificates.
        type: bool
        default: true
      timeout:
        description: Request timeout in seconds.
        type: int
      token:
        description: API token (VAST 5.3+). Mutually exclusive with username/password.
        type: str
      username:
        description: Username for authentication. Mutually exclusive with token.
        type: str
      password:
        description: Password for authentication. Mutually exclusive with token.
        type: str
      tenant:
        description: Tenant name (optional).
        type: str
      api_version:
        description: API version (optional). Defaults to 'latest' if not specified.
        type: str
  id:
    description: Resource ID for direct lookup. Mutually exclusive with name-based identification.
    type: int
  create_dir:
    description: "Set to true to create the directory if the directory was not created yet."
    type: bool

  create_dir_mode:
    description: "Unix permissions mode for the new directory"
    type: int

  default_email:
    description: |
      Emails are sent to users if and when they exceed their user/group quota limits. default_email is a default email
      address that is used instead of a user's email address in the event that no email address is found for the user
      on a provider and no email suffix is set.
    type: str

  default_group_quota:
    description: |
      If is_user_quota is true, this parameter can be used to specify a default rule for all groups. If not specified,
      each group is only limited individually by group rules applied to the group through group_quotas.
    type: dict

  default_user_quota:
    description: |
      If is_user_quota is true, this parameter can be used to specify a default rule to limit individual quota usage
      for all users. If not specified, each user is only limited individually by user and group rules applied to the
      user through user_quotas and group_quotas.
    type: dict

  enable_alarms:
    description: |
      True by default. Enables alarms on relevant events for user and group quotas. Applicable only if is_user_quota is
      true. Raises alarms reporting the number of users that exceed their quotas and when one or more users is/are
      blocked from writing to the quota directory.
    type: bool

  enable_email_providers:
    description: |
      Set to true to enable querying Active Directory and LDAP services for user emails when sending user notifications
      to users if they exceed their user/group quota limits. If enabled, the provider query is the first priority
      source for a user's email. If a user's email is not found on the provider, a global suffix is used to form an
      email. If no suffix is set, default_email is used.
    type: bool

  grace_period:
    description: |
      Quota enforcement grace period. An alarm is triggered and write operations are blocked if storage usage continues
      to exceed the soft limit for the grace period. Format: [DD] [HH:[MM:]]s
    type: str

  group_quotas:
    description: "Group Quotas"
    type: list
    elements: dict

  hard_limit:
    description: "Storage usage limit beyond which no writes will be allowed."
    type: int

  hard_limit_inodes:
    description: |
      Number of directories and unique files under the path beyond which no writes will be allowed. A file with
      multiple hardlinks is counted only once.
    type: int

  iam_role_quotas:
    description: "Iam Role Quotas"
    type: list
    elements: dict

  inherit_acl:
    description: "Indicates whether the directory should inherit ACLs from its parent directory"
    type: bool

  is_user_quota:
    description: "Is User Quota"
    type: bool

  name:
    description: "Quota name"
    type: str

  path:
    description: "The directory path on which to enforce the quota"
    type: str
    required: true

  soft_limit:
    description: "Storage usage limit at which warnings of exceeding the quota are issued."
    type: int

  soft_limit_inodes:
    description: |
      Number of directories and unique files under the path at which warnings of exceeding the quota will be issued. A
      file with multiple hardlinks is counted only once.
    type: int

  tenant_id:
    description: "Tenant ID"
    type: int

  user_quotas:
    description: |
      An array of user quota rule objects. A user quota rule overrides a default user quota rule for the specified
      user.
    type: list
    elements: dict
  state:
    description: Desired state of the resource.
    type: str
    choices: [present, absent]
    default: present
  wait:
    description: Wait for async operations to complete.
    type: bool
    default: true
  wait_timeout:
    description: Timeout in seconds for async operations.
    type: int
    default: 300
author:
  - VAST Data (@vastdata)
extends_documentation_fragment:
  - ansible.builtin.action_common_attributes
attributes:
  check_mode:
    support: full
  diff_mode:
    support: full
  platform:
    platforms: posix
"""
# END AUTOGENERATED DOCUMENTATION

# BEGIN AUTOGENERATED EXAMPLES
EXAMPLES = r"""
- name: Create Quota
  vastdata.vms.quotas:
    vms:
      host: vast-vms.example.com
      token: "{{ vast_token }}"
    name: "example-name"
    path: "example-path"
    state: present

- name: Update Quota
  vastdata.vms.quotas:
    vms:
      host: vast-vms.example.com
      token: "{{ vast_token }}"
    path: "example-value"
    state: present

- name: Delete Quota
  vastdata.vms.quotas:
    vms:
      host: vast-vms.example.com
      token: "{{ vast_token }}"
    path: "example-value"
    state: absent
"""
# END AUTOGENERATED EXAMPLES

# BEGIN AUTOGENERATED RETURN
RETURN = r"""
changed:
  description: Whether a change was made.
  type: bool
  returned: always
quotas:
  description: The quotas resource data.
  type: dict
  returned: always
  sample:
    id: 1
    path: "example"
diff:
  description: Before/after diff when changed.
  type: dict
  returned: when changed
"""
# END AUTOGENERATED RETURN

# BEGIN AUTOGENERATED IMPORTS
from typing import Any, Dict

from ansible.module_utils.basic import AnsibleModule
from ansible_collections.vastdata.vms.plugins.module_utils.vast.errors import VastError
from ansible_collections.vastdata.vms.plugins.module_utils.vast.resource import BaseResource

# END AUTOGENERATED IMPORTS

# BEGIN AUTOGENERATED ARGUMENT_SPEC
ARGUMENT_SPEC: Dict[str, Any] = {
    "vms": {
        "type": "dict",
        "required": True,
        "options": {
            "host": {"required": True, "type": "str"},
            "validate_certs": {"type": "bool", "default": True},
            "timeout": {"type": "int", "default": None},
            "token": {"type": "str", "default": None, "no_log": True},
            "username": {"type": "str", "default": None},
            "password": {"type": "str", "default": None, "no_log": True},
            "tenant": {"type": "str", "default": None},
            "api_version": {"type": "str", "default": None},
        },
        "mutually_exclusive": [
            ("token", "username"),
            ("token", "password"),
        ],
    },
    "id": {"type": "int", "default": None},
    "create_dir": {"type": "bool", "default": None},
    "create_dir_mode": {"type": "int", "default": None},
    "default_email": {"type": "str", "default": None},
    "default_group_quota": {"type": "dict", "default": None},
    "default_user_quota": {"type": "dict", "default": None},
    "enable_alarms": {"type": "bool", "default": None},
    "enable_email_providers": {"type": "bool", "default": None},
    "grace_period": {"type": "str", "default": None},
    "group_quotas": {"type": "list", "default": None, "elements": "dict"},
    "hard_limit": {"type": "int", "default": None},
    "hard_limit_inodes": {"type": "int", "default": None},
    "iam_role_quotas": {"type": "list", "default": None, "elements": "dict"},
    "inherit_acl": {"type": "bool", "default": None},
    "is_user_quota": {"type": "bool", "default": None},
    "name": {"type": "str", "default": None},
    "path": {"type": "str", "required": True},
    "soft_limit": {"type": "int", "default": None},
    "soft_limit_inodes": {"type": "int", "default": None},
    "tenant_id": {"type": "int", "default": None},
    "user_quotas": {"type": "list", "default": None, "elements": "dict"},
    "state": {"type": "str", "choices": ["present", "absent"], "default": "present"},
    "wait": {"type": "bool", "default": True},
    "wait_timeout": {"type": "int", "default": 300},
}
# END AUTOGENERATED ARGUMENT_SPEC

# BEGIN AUTOGENERATED RESOURCE_CLASS


class QuotaResource(BaseResource):
    """Resource manager for Quota."""

    resource_name = "quotas"
    singular = "quota"
    lookup_field = "path"


# END AUTOGENERATED RESOURCE_CLASS

# BEGIN AUTOGENERATED MAIN


def main() -> None:
    """Module entry point."""
    module = AnsibleModule(
        argument_spec=ARGUMENT_SPEC,
        supports_check_mode=True,
    )

    try:
        resource = QuotaResource(module)
        resource.run()
    except VastError as e:
        module.fail_json(msg=str(e))


if __name__ == "__main__":
    main()
# END AUTOGENERATED MAIN
