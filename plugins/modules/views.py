#!/usr/bin/python
# -*- coding: utf-8 -*-
# Copyright: (c) 2026, VAST Data
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

from __future__ import absolute_import, division, print_function

__metaclass__ = type

# BEGIN AUTOGENERATED DOCUMENTATION
DOCUMENTATION = r"""
---
module: views
short_description: Manage VAST View resources
description:
  - Create, update, or delete VAST View resources.
  - Supports check_mode and diff for idempotent operations.
version_added: "1.0.0"
options:
  vms:
    description: VAST VMS connection parameters.
    type: dict
    required: true
    suboptions:
      host:
        description: VAST VMS hostname or IP address.
        required: true
        type: str
      validate_certs:
        description: Validate SSL certificates.
        type: bool
        default: true
      timeout:
        description: Request timeout in seconds.
        type: int
      token:
        description: API token (VAST 5.3+). Mutually exclusive with username/password.
        type: str
      username:
        description: Username for authentication. Mutually exclusive with token.
        type: str
      password:
        description: Password for authentication. Mutually exclusive with token.
        type: str
      tenant:
        description: Tenant name (optional).
        type: str
      api_version:
        description: API version (optional). Defaults to 'latest' if not specified.
        type: str
  id:
    description: Resource ID for direct lookup. Mutually exclusive with name-based identification.
    type: int
  abac_tags:
    description: "list of ABAC tags"
    type: list
    elements: str

  abe_max_depth:
    description: |
      Restricts ABE to a specified path depth. For example, if max depth is 3, ABE does not affect paths deeper than
      three levels. If not specified, ABE affects all path depths.
    type: int

  abe_protocols:
    description: "The protocols for which Access-Based Enumeration (ABE) is enabled"
    type: list
    elements: str

  alias:
    description: "For NFS-enabled views, a view alias for NFSv3 clients."
    type: str

  allow_anonymous_access:
    description: "Not in use"
    type: bool

  allow_s3_anonymous_access:
    description: |
      Allow S3 anonymous access to S3 bucket. If true, anonymous requests are granted provided that the object ACL
      grants access to the All Users group (in S3 Native security flavor) or the permission mode bits on the requested
      file and directory path grant access permission to 'others' (in NFS security flavor).
    type: bool

  auto_commit:
    description: |
      Applicable if locking is enabled. Sets the auto-commit time for files that are locked automatically. These files
      are locked automatically after the auto-commit period elapses from the time the file is saved. Files locked
      automatically are locked for the default-retention-period, after which they are unlocked. Specify as an integer
      value followed by a letter for the unit (h - hours, d - days, y - years). Example: 2h (2 hours).
    type: str

  bucket:
    description: "Not yet implemented"
    type: str

  bucket_creators:
    description: |
      For S3 endpoint views, specify a list of users, by user name, whose bucket create requests use this view. Any
      request to create an S3 bucket that is sent by S3 API by a specified user will use this S3 Endpoint view. Users
      should not be specified as bucket creators in more than one S3 Endpoint view. Naming a user as a bucket creator
      in two S3 Endpoint views will fail the creation of the view with an error.
    type: list
    elements: str

  bucket_creators_groups:
    description: |
      For S3 endpoint views, specify a list of groups, by group name, whose bucket create requests use this view. Any
      request to create an S3 bucket that is sent by S3 API by a user who belongs to a group listed here will use this
      S3 Endpoint view. Take extra care not to duplicate bucket creators through groups: If you specify a group as a
      bucket creator group in one view and you also specify a user who belongs to that group as a bucket creator user
      in another view, view creation will not fail. Yet, there is a conflict between the two configurations and the
      selection of a view for configuring the user's buckets is not predictable.
    type: list
    elements: str

  bucket_logging:
    description: "Bucket Logging"
    type: dict

  bucket_owner:
    description: "S3 Bucket owner"
    type: str

  bucket_owner_type:
    description: "Bucket Owner Type"
    type: str
    choices: ["USER", "ROLE"]

  create_dir:
    description: "Create a directory at the specified path"
    type: bool

  create_dir_acl:
    description: "Define ACL for the newly created dir"
    type: list
    elements: dict

  create_dir_mode:
    description: "Unix permissions mode for the new dir"
    type: int

  default_retention_period:
    description: |
      Relevant if locking is enabled. Required if s3_locks_retention_mode is set to governance or compliance. Specifies
      a default retention period for objects in the bucket. If set, object versions that are placed in the bucket are
      automatically protected with the specified retention lock. Otherwise, by default, each object version has no
      automatic protection but can be configured with a retention period or legal hold. Specify as an integer followed
      by h for hours, d for days, m for months, or y for years. For example: 2d or 1y.
    type: str

  event_notifications:
    description: "Event Notifications"
    type: list
    elements: dict

  files_retention_mode:
    description: |
      Applicable if locking is enabled. The retention mode for new files. For views enabled for NFSv3 or SMB, if
      locking is enabled, files_retention_mode must be set to GOVERNANCE or COMPLIANCE. If the view is enabled for S3
      and not for NFSv3 or SMB, files_retention_mode can be set to NONE. If GOVERNANCE, locked files cannot be deleted
      or changed. The Retention settings can be shortened or extended by users with sufficient permissions. If
      COMPLIANCE, locked files cannot be deleted or changed. Retention settings can be extended, but not shortened, by
      users with sufficient permissions. If NONE (S3 only), the retention mode is not set for the view; it is set
      individually for each object.
    type: str

  indestructible_object_duration:
    description: |
      Retention period for objects, in days. Each object in the bucket is protected from deletion, overwriting,
      renaming and metadata changes for the specified number of days after its creation date.
    type: int

  inherit_acl:
    description: "Indicates whether the directory should inherit ACLs from its parent directory"
    type: bool

  is_default_subsystem:
    description: |
      Set to true to set view to be the default subsystem for block storage. There can be up to one default subsystem
      per tenant. The default subsystem is the default view selected when creating a block volume if no view is
      specified.
    type: bool

  is_indestructible_object_enabled:
    description: |
      Set to true to enable indestructible object mode on the view. This is supported only if S3 is the only specified
      protocol. Other limitations also apply.
    type: bool

  is_kafka_encrypted_conn_allowed:
    description: "True if encrypted connection is allowed for Kafka"
    type: bool

  is_kafka_unencrypted_conn_allowed:
    description: "True if unencrypted connection is allowed for Kafka"
    type: bool

  is_seamless:
    description: |
      Supports seamless failover between replication peers by syncing file handles between the view and remote views on
      the replicated path on replication peers. This enables NFSv3 client users to retain the same mount point to the
      view in the event of a failover of the view path to a replication peer. This feature enables NFSv3 client users
      to retain the same mount point to the view in the event of a failover of the view path to a replication peer.
      Enabling this option may cause overhead and should only be enabled when the use case is relevant. To complete the
      configuration for seamless failover between any two peers, a seamless view must be created on each peer.
    type: bool

  kafka_encrypted_auth_mechanism:
    description: "Authentication mechanism for encrypted connection"
    type: str
    choices: ["NONE", "SASL_PLAIN"]

  kafka_first_join_group_timeout_sec:
    description: "Kafka first join group timeout, in seconds"
    type: int

  kafka_is_authorization_required:
    description: "True if authorization is required for Kafka"
    type: bool

  kafka_rejoin_group_timeout_sec:
    description: "Kafka rejoin group timeout, in seconds"
    type: int

  kafka_unencrypted_auth_mechanism:
    description: "Authentication mechanism for unencrypted connection"
    type: str
    choices: ["NONE", "SASL_PLAIN"]

  kafka_vip_pools:
    description: |
      For Kafka-enabled views, an array of IDs of Virtual IP pools used to access event topics exposed by the view. The
      specified virtual IP pool must belong to the same tenant as the Kafka-enabled view. Must also not be a virtual IP
      pool that is excluded by the view policy's virtual IP pool association.
    type: list
    elements: int

  locking:
    description: |
      Set to true to enable object locking on an S3 bucket. Object locking cannot be disabled after the view is
      modified. Must be true if s3_versioning is true.
    type: bool

  max_retention_period:
    description: |
      Applicable if locking is enabled. Sets a maximum retention period for files that are locked in the view. Files
      cannot be locked for longer than this period, whether they are locked manually (by setting the atime) or
      automatically, using auto-commit. Specify as an integer value followed by a letter for the unit (m - minutes, h -
      hours, d - days, y - years). Example: 2y (2 years).
    type: str

  min_retention_period:
    description: |
      Applicable if locking is enabled. Sets a minimum retention period for files that are locked in the view. Files
      cannot be locked for less than this period, whether locked manually (by setting the atime) or automatically,
      using auto-commit. Specify as an integer value followed by a letter for the unit (h - hours, d - days, m -
      months, y - years). Example: 1d (1 day).
    type: str

  name:
    description: "View name"
    type: str

  nfs_interop_flags:
    description: "Indicates whether the view should support simultaneous access to NFS3/NFS4/SMB protocols."
    type: str
    choices:
      - BOTH_NFS3_AND_NFS4_INTEROP_DISABLED
      - ONLY_NFS3_INTEROP_ENABLED
      - ONLY_NFS4_INTEROP_ENABLED
      - BOTH_NFS3_AND_NFS4_INTEROP_ENABLED

  owner:
    description: |
      The owner of the folder. Specify the owner using the attribute type set by owner_type. You can specify a group as
      the owner, as supported by SMB. To enable setting a group as the owner, set owner_is_group=true. In all cases,
      set owning_group also.
    type: str

  owner_is_group:
    description: |
      Set to true if passing a group as the owner of the folder. This feature is used to enable setting a group as the
      owner, as supported by SMB.
    type: bool

  owner_type:
    description: "The type of attribute used to specify owner."
    type: str

  owning_group:
    description: "The owning group of the folder."
    type: str

  owning_group_type:
    description: "The type of attribute to use to specify the owning group of the folder."
    type: str

  path:
    description: "View path"
    type: str

  policy_id:
    description: |
      View policy ID. Specify to change which view policy the view uses. Every view must be attached to one view
      policy, which specifies further configurations.
    type: int

  protocols:
    description: |
      Client protocols enabled for access to the view. 'NFS' enables access from NFS version 3, 'NFS4' enables access
      from NFS version 4.1 and 4.2, S3' creates an S3 bucket on the view, 'ENDPOINT' creates an S3 endpoint, used as
      template for views created via S3 RPCs, DATABASE exposes the view as a VAST database. KAFKA enables events
      related to elements on the view path to be published to the VAST Event Broker. BLOCK exposes the view as a block
      storage subsystem.
    type: list
    elements: str

  qos_policy:
    description: "QoS Policy"
    type: str

  qos_policy_id:
    description: "Associates a QoS policy with the view."
    type: int

  s3_locks_retention_mode:
    description: |
      The retention mode for new object versions stored in this bucket. You can override this if you upload a new
      object version with an explicit retention mode and period.
    type: str

  s3_object_ownership_rule:
    description: "S3 Object Ownership Rule"
    type: str

  s3_unverified_lookup:
    description: "S3 Unverified Lookup"
    type: bool

  s3_versioning:
    description: "Enable S3 Versioning if S3 bucket. Versioning cannot be disabled after the view is modified."
    type: bool

  select_for_live_monitoring:
    description: |
      Enables live monitoring on the view. Live monitoring can be enabled for up to ten views at one time. Analytics
      data for views is polled every 5 minutes by default and every 10 seconds with live monitoring.
    type: bool

  share:
    description: "SMB share name"
    type: str

  share_acl:
    description: "Share-level ACL details"
    type: dict

  smb_encryption_state:
    description: "Defines the encryption level for SMB"
    type: str
    choices: ["AVAILABLE", "DESIRED", "REQUIRED"]

  tenant_id:
    description: "Associates the specified tenant with the view."
    type: int

  user_impersonation:
    description: "User Impersonation"
    type: dict
  state:
    description: Desired state of the resource.
    type: str
    choices: [present, absent]
    default: present
  wait:
    description: Wait for async operations to complete.
    type: bool
    default: true
  wait_timeout:
    description: Timeout in seconds for async operations.
    type: int
    default: 300
author:
  - VAST Data (@vastdata)
extends_documentation_fragment:
  - ansible.builtin.action_common_attributes
attributes:
  check_mode:
    support: full
  diff_mode:
    support: full
  platform:
    platforms: posix
"""
# END AUTOGENERATED DOCUMENTATION

# BEGIN AUTOGENERATED EXAMPLES
EXAMPLES = r"""
- name: Create View
  vastdata.vms.views:
    vms:
      host: vast-vms.example.com
      token: "{{ vast_token }}"
    path: "example-path"
    policy_id: 1
    state: present

- name: Update View
  vastdata.vms.views:
    vms:
      host: vast-vms.example.com
      token: "{{ vast_token }}"
    path: "example-value"
    state: present

- name: Delete View
  vastdata.vms.views:
    vms:
      host: vast-vms.example.com
      token: "{{ vast_token }}"
    path: "example-value"
    state: absent
"""
# END AUTOGENERATED EXAMPLES

# BEGIN AUTOGENERATED RETURN
RETURN = r"""
changed:
  description: Whether a change was made.
  type: bool
  returned: always
views:
  description: The views resource data.
  type: dict
  returned: always
  sample:
    id: 1
    path: "example"
diff:
  description: Before/after diff when changed.
  type: dict
  returned: when changed
"""
# END AUTOGENERATED RETURN

# BEGIN AUTOGENERATED IMPORTS
from typing import Any, Dict

from ansible.module_utils.basic import AnsibleModule
from ansible_collections.vastdata.vms.plugins.module_utils.vast.errors import VastError
from ansible_collections.vastdata.vms.plugins.module_utils.vast.resource import BaseResource

# END AUTOGENERATED IMPORTS

# BEGIN AUTOGENERATED ARGUMENT_SPEC
ARGUMENT_SPEC: Dict[str, Any] = {
    "vms": {
        "type": "dict",
        "required": True,
        "options": {
            "host": {"required": True, "type": "str"},
            "validate_certs": {"type": "bool", "default": True},
            "timeout": {"type": "int", "default": None},
            "token": {"type": "str", "default": None, "no_log": True},
            "username": {"type": "str", "default": None},
            "password": {"type": "str", "default": None, "no_log": True},
            "tenant": {"type": "str", "default": None},
            "api_version": {"type": "str", "default": None},
        },
        "mutually_exclusive": [
            ("token", "username"),
            ("token", "password"),
        ],
    },
    "id": {"type": "int", "default": None},
    "abac_tags": {"type": "list", "default": None, "elements": "str"},
    "abe_max_depth": {"type": "int", "default": None},
    "abe_protocols": {"type": "list", "default": None, "elements": "str"},
    "alias": {"type": "str", "default": None},
    "allow_anonymous_access": {"type": "bool", "default": None},
    "allow_s3_anonymous_access": {"type": "bool", "default": None},
    "auto_commit": {"type": "str", "default": None},
    "bucket": {"type": "str", "default": None},
    "bucket_creators": {"type": "list", "default": None, "elements": "str"},
    "bucket_creators_groups": {"type": "list", "default": None, "elements": "str"},
    "bucket_logging": {"type": "dict", "default": None},
    "bucket_owner": {"type": "str", "default": None},
    "bucket_owner_type": {"type": "str", "default": None, "choices": ["USER", "ROLE"]},
    "create_dir": {"type": "bool", "default": None},
    "create_dir_acl": {"type": "list", "default": None, "elements": "dict"},
    "create_dir_mode": {"type": "int", "default": None},
    "default_retention_period": {"type": "str", "default": None},
    "event_notifications": {"type": "list", "default": None, "elements": "dict"},
    "files_retention_mode": {"type": "str", "default": None},
    "indestructible_object_duration": {"type": "int", "default": None},
    "inherit_acl": {"type": "bool", "default": None},
    "is_default_subsystem": {"type": "bool", "default": None},
    "is_indestructible_object_enabled": {"type": "bool", "default": None},
    "is_kafka_encrypted_conn_allowed": {"type": "bool", "default": None},
    "is_kafka_unencrypted_conn_allowed": {"type": "bool", "default": None},
    "is_seamless": {"type": "bool", "default": None},
    "kafka_encrypted_auth_mechanism": {"type": "str", "default": None, "choices": ["NONE", "SASL_PLAIN"]},
    "kafka_first_join_group_timeout_sec": {"type": "int", "default": None},
    "kafka_is_authorization_required": {"type": "bool", "default": None},
    "kafka_rejoin_group_timeout_sec": {"type": "int", "default": None},
    "kafka_unencrypted_auth_mechanism": {"type": "str", "default": None, "choices": ["NONE", "SASL_PLAIN"]},
    "kafka_vip_pools": {"type": "list", "default": None, "elements": "int"},
    "locking": {"type": "bool", "default": None},
    "max_retention_period": {"type": "str", "default": None},
    "min_retention_period": {"type": "str", "default": None},
    "name": {"type": "str", "default": None},
    "nfs_interop_flags": {
        "type": "str",
        "default": None,
        "choices": [
            "BOTH_NFS3_AND_NFS4_INTEROP_DISABLED",
            "ONLY_NFS3_INTEROP_ENABLED",
            "ONLY_NFS4_INTEROP_ENABLED",
            "BOTH_NFS3_AND_NFS4_INTEROP_ENABLED",
        ],
    },
    "owner": {"type": "str", "default": None},
    "owner_is_group": {"type": "bool", "default": None},
    "owner_type": {"type": "str", "default": None},
    "owning_group": {"type": "str", "default": None},
    "owning_group_type": {"type": "str", "default": None},
    "path": {"type": "str", "default": None},
    "policy_id": {"type": "int", "default": None},
    "protocols": {"type": "list", "default": None, "elements": "str"},
    "qos_policy": {"type": "str", "default": None},
    "qos_policy_id": {"type": "int", "default": None},
    "s3_locks_retention_mode": {"type": "str", "default": None},
    "s3_object_ownership_rule": {"type": "str", "default": None},
    "s3_unverified_lookup": {"type": "bool", "default": None},
    "s3_versioning": {"type": "bool", "default": None},
    "select_for_live_monitoring": {"type": "bool", "default": None},
    "share": {"type": "str", "default": None},
    "share_acl": {"type": "dict", "default": None},
    "smb_encryption_state": {"type": "str", "default": None, "choices": ["AVAILABLE", "DESIRED", "REQUIRED"]},
    "tenant_id": {"type": "int", "default": None},
    "user_impersonation": {"type": "dict", "default": None},
    "state": {"type": "str", "choices": ["present", "absent"], "default": "present"},
    "wait": {"type": "bool", "default": True},
    "wait_timeout": {"type": "int", "default": 300},
}
# END AUTOGENERATED ARGUMENT_SPEC

# BEGIN AUTOGENERATED RESOURCE_CLASS


class ViewResource(BaseResource):
    """Resource manager for View."""

    resource_name = "views"
    singular = "view"
    lookup_field = "path"


# END AUTOGENERATED RESOURCE_CLASS

# BEGIN AUTOGENERATED MAIN


def main() -> None:
    """Module entry point."""
    module = AnsibleModule(
        argument_spec=ARGUMENT_SPEC,
        supports_check_mode=True,
    )

    try:
        resource = ViewResource(module)
        resource.run()
    except VastError as e:
        module.fail_json(msg=str(e))


if __name__ == "__main__":
    main()
# END AUTOGENERATED MAIN
